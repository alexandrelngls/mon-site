<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Personnel - Connexion</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☁️</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="login-container glass-container">
        <div class="logo">
            <h1>☁️ Cloud Personnel</h1>
            <p>Accédez à votre espace sécurisé</p>
        </div>
        
        <div id="loading-session" class="message info" style="display: none;">
            <span class="loading-spinner"></span>Vérification de la session...
        </div>
        
        <div id="message" class="message"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Adresse email</label>
                <input type="email" id="email" name="email" required autocomplete="email" class="input-field">
            </div>
            
            <div class="form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" name="password" required autocomplete="current-password" class="input-field">
            </div>
            
            <button type="submit" class="btn-primary login-btn" id="loginBtn">
                Se connecter
            </button>
        </form>
        
        <div class="footer">
            <p>© 2025 Cloud Personnel - Sécurisé par Supabase</p>
        </div>
    </div>

    <script>
        // Configuration
        const WORKER_URL = 'https://cloude-prive-alexandre.alexandre-lngls.workers.dev';
        
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const messageDiv = document.getElementById('message');
        const loadingSessionDiv = document.getElementById('loading-session');
        
        // Fonction: Vérifier si une session existe déjà
        async function checkExistingSession() {
            loadingSessionDiv.style.display = 'block';
            loginForm.style.opacity = '0.5';
            loginBtn.disabled = true;
            
            try {
                const response = await fetch(`${WORKER_URL}/verify-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                loadingSessionDiv.style.display = 'none';
                loginForm.style.opacity = '1';
                loginBtn.disabled = false;
                
                if (result.success) {
                    showMessage('Session active détectée. Redirection...', 'success');
                    setTimeout(() => window.location.href = '/dashboard', 1000);
                }
            } catch (error) {
                console.error('Erreur vérification session:', error);
                loadingSessionDiv.style.display = 'none';
                loginForm.style.opacity = '1';
                loginBtn.disabled = false;
            }
        }
        
        // Fonction: Afficher un message
        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => messageDiv.style.display = 'none', 2000);
            }
        }
        
        // Fonction: Gérer l'état de chargement
        function setLoading(loading) {
            if (loading) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="loading-spinner"></span>Connexion...';
            } else {
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Se connecter';
            }
        }
        
        // Gestionnaire: Soumission du formulaire
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!email || !password) {
                showMessage('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            setLoading(true);
            messageDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showMessage('Connexion réussie', 'success');
                    setTimeout(() => window.location.href = '/dashboard', 1500);
                } else {
                    const text = await response.text();
                    showMessage(text || 'Email ou mot de passe incorrect', 'error');
                }
            } catch (error) {
                console.error('Erreur connexion:', error);
                showMessage('Erreur de connexion. Veuillez réessayer.', 'error');
            } finally {
                setLoading(false);
            }
        });
        
        // Effacer les messages d'erreur lors de la saisie
        document.getElementById('email').addEventListener('input', () => {
            if (messageDiv.classList.contains('error')) {
                messageDiv.style.display = 'none';
            }
        });
        
        document.getElementById('password').addEventListener('input', () => {
            if (messageDiv.classList.contains('error')) {
                messageDiv.style.display = 'none';
            }
        });
        
        // Vérifier la session au chargement
        document.addEventListener('DOMContentLoaded', checkExistingSession);
    </script>
</body>
</html> 
