<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Privé - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <h1>Mon Drive Privé</h1>
            <button onclick="handleLogout()" class="btn btn-primary">Déconnexion</button>
        </div>

        <div id="errorAlert" class="alert alert-error"></div>
        <div id="successAlert" class="alert alert-success"></div>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <p>Cliquez ou glissez des fichiers ici pour les uploader</p>
            <input type="file" id="fileInput" style="display: none" multiple onchange="handleFileSelect(event)">
        </div>

        <div id="spinner" class="spinner"></div>
        <div id="filesGrid" class="files-grid"></div>
    </div>

    <script>
        // Configuration
        const WORKER_URL = 'https://cloude-prive-alexandre.alexandre-lngls.workers.dev';
        const supabaseUrl = 'https://nqrtrpsommuudwoakgcp.supabase.co';
        const supabaseAnonKey = '{{SUPABASE_ANON_KEY}}'; // Sera remplacé par le Worker
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Gestion des alertes
        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // Gestion du spinner
        function toggleSpinner(show) {
            document.getElementById('spinner').style.display = show ? 'block' : 'none';
        }

        // Vérification de l'authentification
        async function checkAuth() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = '/index.html';
                return null;
            }
            return session.access_token;
        }

        // Déconnexion
        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.href = '/index.html';
        }

        // Chargement des fichiers
        async function loadFiles() {
            const token = await checkAuth();
            if (!token) return;

            toggleSpinner(true);
            try {
                const response = await fetch(`${WORKER_URL}/list-files`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Erreur lors du chargement des fichiers');
                
                const files = await response.json();
                displayFiles(files);
            } catch (error) {
                showError(error.message);
            } finally {
                toggleSpinner(false);
            }
        }

        // Affichage des fichiers
        function displayFiles(files) {
            const grid = document.getElementById('filesGrid');
            grid.innerHTML = '';

            files.forEach(file => {
                const card = document.createElement('div');
                card.className = 'file-card';

                const preview = document.createElement('img');
                preview.className = 'file-preview';
                preview.src = file.isImage ? file.url : '/assets/file-icon.png';
                preview.alt = file.name;

                const name = document.createElement('div');
                name.className = 'file-name';
                name.textContent = file.name;

                const actions = document.createElement('div');
                actions.className = 'file-actions';

                const downloadBtn = document.createElement('a');
                downloadBtn.href = file.url;
                downloadBtn.className = 'btn btn-primary';
                downloadBtn.textContent = 'Télécharger';
                downloadBtn.download = file.name;

                actions.appendChild(downloadBtn);
                card.appendChild(preview);
                card.appendChild(name);
                card.appendChild(actions);
                grid.appendChild(card);
            });
        }

        // Upload de fichiers
        async function handleFileSelect(event) {
            const token = await checkAuth();
            if (!token) return;

            const files = event.target.files;
            if (!files.length) return;

            toggleSpinner(true);

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${WORKER_URL}/upload-file`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (!response.ok) throw new Error(`Erreur lors de l'upload de ${file.name}`);
                    
                    showSuccess(`${file.name} uploadé avec succès`);
                } catch (error) {
                    showError(error.message);
                }
            }

            toggleSpinner(false);
            loadFiles(); // Rechargement de la liste
            event.target.value = ''; // Reset input
        }

        // Drag & Drop
        const uploadZone = document.getElementById('uploadZone');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--primary-color)';
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.style.borderColor = 'var(--border-color)';
        });

        uploadZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--border-color)';
            
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length) {
                const event = { target: { files } };
                await handleFileSelect(event);
            }
        });

        // Chargement initial
        document.addEventListener('DOMContentLoaded', loadFiles);
    </script>
</body>
</html> 
