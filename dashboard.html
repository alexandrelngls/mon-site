<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Privé - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .empty-message {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 1.1rem;
            background: #f5f5f5;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="dashboard-header">
            <h1>Mon Drive Privé</h1>
            <button onclick="handleLogout()" class="btn btn-primary">Déconnexion</button>
        </div>

        <div id="errorAlert" class="alert alert-error"></div>
        <div id="successAlert" class="alert alert-success"></div>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <p>Cliquez ou glissez des fichiers ici pour les uploader</p>
            <input type="file" id="fileInput" style="display: none" multiple onchange="handleFileSelect(event)">
        </div>

        <div id="spinner" class="spinner"></div>
        <div id="filesGrid" class="files-grid"></div>
    </div>

    <script>
        // Configuration
        const WORKER_URL = 'https://alexandrelanglois.me';
        const supabaseUrl = '{{SUPABASE_PROJECT_URL}}';
        const supabaseAnonKey = '{{SUPABASE_ANON_KEY}}';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Gestion des alertes
        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // Gestion du spinner
        function toggleSpinner(show) {
            document.getElementById('spinner').style.display = show ? 'block' : 'none';
        }

        // Vérification de l'authentification
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/';
                return null;
            }
            return session.access_token;
        }

        // Déconnexion
        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = '/';
        }

        // Chargement des fichiers
        async function loadFiles() {
            const token = await checkAuth();
            if (!token) return;

            toggleSpinner(true);
            try {
                const response = await fetch(`${WORKER_URL}/list-files`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erreur lors du chargement des fichiers');
                }

                const files = await response.json();
                displayFiles(files);
            } catch (error) {
                if (error.message === 'Failed to fetch') {
                    showError('Impossible de se connecter au serveur');
                } else {
                    showError(error.message);
                }
            } finally {
                toggleSpinner(false);
            }
        }

        // Affichage des fichiers
        function displayFiles(files) {
            const grid = document.getElementById('filesGrid');
            grid.innerHTML = '';

            if (!files || files.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-message';
                emptyMessage.textContent = 'Aucun fichier dans votre drive. Commencez par uploader des fichiers !';
                grid.appendChild(emptyMessage);
                return;
            }

            files.forEach(file => {
                const card = document.createElement('div');
                card.className = 'file-card';

                const preview = document.createElement('div');
                preview.className = 'file-preview';
                
                if (file.isImage) {
                    const img = document.createElement('img');
                    img.src = file.url;
                    img.alt = file.name;
                    preview.appendChild(img);
                } else {
                    preview.innerHTML = '<svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>';
                }

                const name = document.createElement('div');
                name.className = 'file-name';
                name.textContent = file.name;

                const actions = document.createElement('div');
                actions.className = 'file-actions';

                const downloadBtn = document.createElement('a');
                downloadBtn.href = file.url;
                downloadBtn.className = 'btn btn-primary';
                downloadBtn.textContent = 'Télécharger';
                downloadBtn.download = file.name;

                actions.appendChild(downloadBtn);
                card.appendChild(preview);
                card.appendChild(name);
                card.appendChild(actions);
                grid.appendChild(card);
            });
        }

        // Upload de fichiers
        async function handleFileSelect(event) {
            const token = await checkAuth();
            if (!token) return;

            const files = event.target.files;
            if (!files.length) return;

            // Vérification des types de fichiers
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'text/plain'];
            const invalidFiles = Array.from(files).filter(file => !allowedTypes.includes(file.type));
            if (invalidFiles.length > 0) {
                showError(`Types de fichiers non autorisés : ${invalidFiles.map(f => f.name).join(', ')}`);
                return;
            }

            // Vérification de la taille
            const maxSize = 10 * 1024 * 1024; // 10MB
            const oversizedFiles = Array.from(files).filter(file => file.size > maxSize);
            if (oversizedFiles.length > 0) {
                showError(`Fichiers trop volumineux (max 10MB) : ${oversizedFiles.map(f => f.name).join(', ')}`);
                return;
            }

            toggleSpinner(true);

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${WORKER_URL}/upload-file`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur lors de l'upload de ${file.name}`);
                    }

                    showSuccess(`${file.name} uploadé avec succès`);
                } catch (error) {
                    showError(error.message);
                }
            }

            toggleSpinner(false);
            loadFiles();
            event.target.value = '';
        }

        // Gestion du drag & drop
        const uploadZone = document.getElementById('uploadZone');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--primary-color)';
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.style.borderColor = 'var(--border-color)';
        });

        uploadZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'var(--border-color)';
            
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length) {
                const event = { target: { files } };
                await handleFileSelect(event);
            }
        });

        // Vérification initiale et chargement des fichiers
        document.addEventListener('DOMContentLoaded', async () => {
            const token = await checkAuth();
            if (token) {
                loadFiles();
            }
        });
    </script>
</body>
</html> 
